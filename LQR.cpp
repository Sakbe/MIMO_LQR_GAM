
//******************************************************************************
//
//		LQR.cpp - LQR CONTROL AND KALMAN FILTER
//		CORONA - CIANCIULLI 05/2019
//
//******************************************************************************

#include "LQR.h"

//OBJECTLOADREGISTER(IPID,"$Id: IPID.cpp,v 1.0 29/4/2011 14:22:36 ivoc Exp $")
// if cycle time is supplied
//CONSTRUCTOR AND DESTRUCTOR
LQR::LQR(){
	//this-> N_state = 10;
	//this-> N_input = 2;
	//this-> N_output = 2;

	this-> X_LQR = (float[N_state]){0, 0, 0, 0, 0, 0, 0, 0, 0, 0};

	this-> x_dot_pos = (float[N_state]){0, 0, 0, 0, 0, 0, 0, 0, 0, 0};

	this-> x_pos = (float[N_state]){0.0983539734804260, 0.480564466137287, -0.204246862173158, 0.0605647026605041, -0.369796209977501, 0.111380460346364, 0.0194246756583234, 0.144179620264490, -0.0534417070457820, 0.215640033094750};

	//this-> K_LQR_pos =(float[N_input * N_state]) {-39.8874724584811, -70.6769666120137, 354.869808121735, 370.159896447712, -106.569303855515, -10.6727031034049, -29.8250480200422, 75.3583282160950, -135.655340474040, -27.8586258177635,
	//						4.85034537803885, 16.3699444462248, -103.189045436383, -88.9493312103841, 36.1506690550597, 19.0337453517795, 10.4943236824918, -28.3848265454111, 45.6326833691854, 8.77044127460252};

		this-> A_est_pos= (float[N_state * N_state]) {0.771434903,	-0.021348163,	0.026153579,	-0.003034116,	0.00033719,	0.005463117,	0.008698117,	0.001348557,	-0.001405753,	-0.005695,
-0.366069525,	0.250144333,	0.001444294,	-0.067050375,	-0.00747909,	-0.046246402,	0.074281342,	-0.063517481,	-0.077964701,	-0.021003148,
4.335814953,	-0.590004861,	0.597714961,	-0.014256048,	0.061607752,	-0.135960534,	-0.082231559,	-0.145310953,	-0.07786762,	0.105946757,
-0.549529731,	-0.505382001,	-0.01467749,	0.903384328,	0.113554217,	0.013634915,	0.116127744,	-0.001548065,	-0.129825935,	-0.025932135,
-6.09044838,	-0.046373639,	0.166769952,	-0.164827242,	0.951034069,	0.334019393,	-0.070105106,	0.032830406,	-0.039465945,	-0.072917856,
-2.646726131,	-1.392825127,	0.135581598,	-0.017703824,	-0.359038204,	0.903093755,	0.00646944,	-0.189019114,	-0.071997091,	0.033450905,
2.133527994,	2.22832036,	0.021729587,	0.042188793,	0.052367792,	0.019750303,	0.83642447,	0.234644026,	0.059001833,	0.321341515,
0.096559733,	-0.928759277,	0.002022055,	-0.028890036,	-0.112281762,	0.043850061,	-0.269708097,	0.819548965,	-0.468864441,	0.17143555,
-0.25124827,	1.261878371,	0.134749249,	0.002615248,	0.035810255,	0.022211017,	-0.044809174,	0.296370924,	0.880721569,	-0.150740668,
3.595902443,	-0.37080878,	-0.199803695,	0.015529932,	-0.002768105,	-0.041213844,	-0.194448233,	-0.153701216,	0.084358327,	0.940047324};

	this-> B_est_pos=(float[N_state * ( N_input +  N_output)])  {-0.00000679,	-0.00012818,	-0.00005677,	0.00029762,	-0.00025856,	-0.00040971,	0.00209464,	-0.00058639,	-0.00039295,	-0.00014068,
								     -0.00000863,	-0.00015073,	0.00033058,	0.00049966,	-0.00064293,	-0.00056508,	0.00148645,	0.00029543,	0.00006341,	-0.00103388,
								      0.10402035,	5.2415452,	2.17423749,	1.51000249,	-5.00431633,	0.9971475,	-10.28696442,	-24.65203667,	-15.71390247,	11.22548389,
								      -0.54193759,	-2.40042901,	-9.54350567,	0.80970061,	-5.09362936,	10.18571663,	15.79635048,	11.09492016,	15.2142601,	-25.07771301};
	//B_est_pos =[vertical; horizonal; rc; zc]

	this-> C_est_pos=(float[N_state * (N_state +  N_output)])  {0.117056169,	0.026251998,	-0.003811811,	-0.000269252,	0.000071083,	-0.000344695,	0.000170941,	-0.000610935,	-0.00031992,	0.000382334,
0.1303069,	-0.002285592,	-0.005423918,	-0.000344409,	0.000059554,	-0.000417361,	-0.000087633,	-0.000634914,	-0.000244024,	0.000796742,
0.783260882,	-0.027212553,	0.00785953,	0.00052888,	-0.000118324,	0.000661077,	-0.000127797,	0.001100519,	0.000516234,	-0.000959923,
0.121271349,	0.125358284,	-0.037739728,	-0.001557684,	-0.000486643,	-0.001320118,	-0.007777475,	0.000660145,	0.002877327,	0.011018277,
4.491700172,	-0.507688284,	0.796966255,	-0.01248,	0.001786376,	-0.014844493,	-0.006803832,	-0.021270597,	-0.006885507,	0.032515604,
0.954077303,	-0.712801874,	-0.06579335,	0.996491373,	0.000003596,	-0.003799102,	-0.006781216,	-0.003650652,	0.000689936,	0.014032086,
-4.158698082,	0.410507441,	0.18575041,	0.011470341,	0.998309076,	0.013680383,	0.00577423,	0.019779028,	0.006586887,	-0.029403677,
-4.391922474,	-1.145311236,	0.137010559,	0.009874942,	-0.002766647,	1.012761712,	-0.007827932,	0.023152038,	0.012573844,	-0.012456535,
-1.097618341,	2.447838783,	0.136683211,	0.006344616,	0.001007164,	0.006108885,	1.022159219,	0.001865919,	-0.006585477,	-0.035315961,
-1.920884728,	0.568216145,	0.099983096,	0.005834932,	-0.000545818,	0.006723195,	0.006006531,	1.008592963,	0.00169537,	-0.018040769,
-0.712583721,	1.432452202,	0.082864389,	0.003896785,	0.000556503,	0.003798607,	0.013003765,	0.001436061,	0.99628222,	-0.021081693,
3.456563711,	0.012501119,	-0.141136557,	-0.009032226,	0.001625186,	-0.010992962,	-0.001679561,	-0.016946778,	-0.006733265,	1.020273328};

this-> D_est_pos=(float[(N_state + N_output) * (N_input + N_output)]) {0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,
0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,
0.869301736,	-0.007374771,	0.148214549,	3.817733765,	1.625854492,	2.997158289,	-1.244319558,	5.606616497,	-10.583392143,	-2.234328032,	-6.183921814,	-0.516182721,
-0.506077468,	0.370243132,	0.982124746,	-2.424515486,	-22.611539841,	-6.077579498,	20.809724808,	18.650072098,	10.421789169,	10.409658432,	6.435731411,	-16.551050186};

//	this-> N_BAR_pos = (float[N_input +  N_output]){-16738.8719868375, 3479.82442345434,
//							488.651395096507, -28.3958381254954};



	//more slow
	this-> N_BAR_pos = (float[N_input +  N_output]){-10292.2693526553, 2133.74129809333,
							-944.140351815484, 269.810568562941};
	this-> K_LQR_pos =(float[N_input * N_state]) {-0.677239930551175, -5.56445051715661, 29.1530400398665, 10.5689835482429, -6.43042836144154, 0.784006911127944, -1.67848331436731, 6.89611601694075, -11.6198347798690, -4.41024916164279,
							-0.253637909222695, 0.998896201615173, -6.91291373508615, -4.34730845911924, 2.02654430640833, 0.350198601401546, 0.540286005706202, -1.95918796444674, 3.18376611395890, 0.992300688479676};



	
	this-> x_neg=(float[N_state])  {-0.01322152646,	0.21257243483,	0.24681826366,	-0.33280829935,	-0.00461930354,	0.02045689304,	-0.05335478233,	0.02913866606,	-0.38100515631,	-0.01904457052};
	this-> x_dot_neg=(float[N_state])  {0, 0, 0, 0, 0, 0, 0, 0, 0, 0};
//	this-> K_LQR_neg=(float[N_input * N_state])  {-1.10243700688381, -26.6888168111469, 248.208386299799, 2272.69314089294, 341.435985384170, 116.974185358079, -1571.00753489878, -331.351679250269, -1271.06969797964, -4441.09340489016,
//							-0.233414809301534, -21.1374545809135, 237.120488501101, 3170.68925311282, -143.026532612836, 258.466914847382, -1451.21045848359, -298.057584698670, -925.765520002125, -4247.87411829111};

this-> A_est_neg=(float[N_state * N_state]){0.7714349,	-0.0213482,	0.0261536,	-0.0030341,	0.0003372,	0.0054631,	0.0086981,	0.0013486,	-0.0014058,	-0.005695,
-0.3660695,	0.2501443,	0.0014443,	-0.0670504,	-0.0074791,	-0.0462464,	0.0742813,	-0.0635175,	-0.0779647,	-0.0210031,
4.335815,	-0.5900049,	0.597715,	-0.014256,	0.0616078,	-0.1359605,	-0.0822316,	-0.145311,	-0.0778676,	0.1059468,
-0.5495297,	-0.505382,	-0.0146775,	0.9033843,	0.1135542,	0.0136349,	0.1161277,	-0.0015481,	-0.1298259,	-0.0259321,
-6.0904484,	-0.0463736,	0.16677,	-0.1648272,	0.9510341,	0.3340194,	-0.0701051,	0.0328304,	-0.0394659,	-0.0729179,
-2.6467261,	-1.3928251,	0.1355816,	-0.0177038,	-0.3590382,	0.9030938,	0.0064694,	-0.1890191,	-0.0719971,	0.0334509,
2.133528,	2.2283204,	0.0217296,	0.0421888,	0.0523678,	0.0197503,	0.8364245,	0.234644,	0.0590018,	0.3213415,
0.0965597,	-0.9287593,	0.0020221,	-0.02889,	-0.1122818,	0.0438501,	-0.2697081,	0.819549,	-0.4688644,	0.1714355,
-0.2512483,	1.2618784,	0.1347492,	0.0026152,	0.0358103,	0.022211,	-0.0448092,	0.2963709,	0.8807216,	-0.1507407,
3.5959024,	-0.3708088,	-0.1998037,	0.0155299,	-0.0027681,	-0.0412138,	-0.1944482,	-0.1537012,	0.0843583,	0.9400473};
	
this-> B_est_neg=(float[N_state * ( N_input +  N_output)]) {-0.00001070484,	-0.00018352285,	-0.00003740476,	-0.00016039671,	-0.00002731199,	-0.00028521486,	0.00069076713,	0.00005484348,	0.00036286309,	-0.0000075353,
0.00000686852,	0.00057635334,	0.00029789837,	0.00083011913,	0.00079056883,	0.00058172137,	-0.00060404028,	0.00136100687,	0.00043902177,	-0.00052344694,
0.09111382812,	3.10450434685,	2.15178990364,	2.05216526985,	0.90967023373,	6.48992204666,	-9.77224636078,	4.14700937271,	-5.76749849319,	1.19782984257,
1.08479273319,	0.27581769228,	-22.09374046326,	1.84148490429,	29.0894241333,	10.08295822144,	-5.69981622696,	-2.06448793411,	4.06499624252,	-17.97842979431};
	
this-> C_est_neg=(float[N_state * (N_state +  N_output)]) {0.11705617,	0.026252,	-0.00381181,	-0.00026925,	0.00007108,	-0.00034469,	0.00017094,	-0.00061093,	-0.00031992,	0.00038233,
0.1303069,	-0.00228559,	-0.00542392,	-0.00034441,	0.00005955,	-0.00041736,	-0.00008763,	-0.00063491,	-0.00024402,	0.00079674,
0.78326088,	-0.02721255,	0.00785953,	0.00052888,	-0.00011832,	0.00066108,	-0.0001278,	0.00110052,	0.00051623,	-0.00095992,
0.12127135,	0.12535828,	-0.03773973,	-0.00155768,	-0.00048664,	-0.00132012,	-0.00777747,	0.00066015,	0.00287733,	0.01101828,
4.49170017,	-0.50768828,	0.79696625,	-0.01248,	0.00178638,	-0.01484449,	-0.00680383,	-0.0212706,	-0.00688551,	0.0325156,
0.9540773,	-0.71280187,	-0.06579335,	0.99649137,	0.0000036,	-0.0037991,	-0.00678122,	-0.00365065,	0.00068994,	0.01403209,
-4.15869808,	0.41050744,	0.18575041,	0.01147034,	0.99830908,	0.01368038,	0.00577423,	0.01977903,	0.00658689,	-0.02940368,
-4.39192247,	-1.14531124,	0.13701056,	0.00987494,	-0.00276665,	1.01276171,	-0.00782793,	0.02315204,	0.01257384,	-0.01245654,
-1.09761834,	2.44783878,	0.13668321,	0.00634462,	0.00100716,	0.00610889,	1.02215922,	0.00186592,	-0.00658548,	-0.03531596,
-1.92088473,	0.56821615,	0.0999831,	0.00583493,	-0.00054582,	0.00672319,	0.00600653,	1.00859296,	0.00169537,	-0.01804077,
-0.71258372,	1.4324522,	0.08286439,	0.00389678,	0.0005565,	0.00379861,	0.01300376,	0.00143606,	0.99628222,	-0.02108169,
3.45656371,	0.01250112,	-0.14113656,	-0.00903223,	0.00162519,	-0.01099296,	-0.00167956,	-0.01694678,	-0.00673327,	1.02027333};
	

this-> D_est_neg=(float[(N_state + N_output) * (N_input + N_output)]){0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,
0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,
0.86930174,	-0.00737477,	0.14821455,	3.81773376,	1.62585449,	2.99715829,	-1.24431956,	5.6066165,	-10.58339214,	-2.23432803,	-6.18392181,	-0.51618272,
-0.50607747,	0.37024313,	0.98212475,	-2.42451549,	-22.61153984,	-6.0775795,	20.80972481,	18.6500721,	10.42178917,	10.40965843,	6.43573141,	-16.55105019};

	
//	this-> N_BAR_neg=(float[N_input +  N_output]) {6692.27395164254, -960.635617013133,
	//						-2256.41280370701, -489.068332481912};


	//more slow
	this-> N_BAR_neg = (float[N_input +  N_output]){6577.20274262693, -953.521247320254,
							-2537.02933847542, -432.837113235285};
	this-> K_LQR_neg =(float[N_input * N_state]) {-0.0143959540956107, -0.325150394017629, 3.13416013810849, 26.5396916000373, 4.19324806144036, 1.55806909562497, -18.7468162690424, -3.85545880019961, -15.3160343140834, -53.4859040919299,
							-0.00458150757613837, -0.243881430718078, 2.88347865234915, 35.3882054725928, -2.01002787695297, 2.81135503841810, -16.8859632308927, -3.47894536276546, -10.3473795912101, -48.0323686610169};


}

LQR::~LQR(){
}



//////////////////////////// Controllers /////////////////////////////////////////////////////////


//////////////////////////// Controllers /////////////////////////////////////////////////////////


LQRouputs  LQR::MIMO_CONTROL_POSITIVE(float R_ref, float Z_ref, float R_real, float Z_real, float I_vertical, float I_horizontal){
	float u_Nbar_0 = 0;
	float u_Nbar_1 = 0;
	float u_vertical=0;
	float u_horizontal=0;
	int i = 0;
	int j = 0;
	float temp = 0.0;
	float *outputs;
	outputs =(float[2]) {0, 0};
	LQRouputs Outputs={0,0};
	
	
	
	//Nbar(2x2)
	u_Nbar_0 = (R_ref* this->N_BAR_pos[0]) + (Z_ref* this->N_BAR_pos[1]);
	u_Nbar_1 = (R_ref * this->N_BAR_pos[2]) + (Z_ref * this->N_BAR_pos[3]);
	
	//u=u-k_lqr*x
	for (i = 0; i < N_state; i++) {
		temp += this->X_LQR[i] * this->K_LQR_pos[i];
		}
	u_vertical = u_Nbar_0 - temp;
	temp = 0;		
	
	for (i = 0; i < N_state; i++) {
		temp += this->X_LQR[i] * this->K_LQR_pos[i+N_state];
		
	}
	u_horizontal = u_Nbar_1 - temp;
	temp = 0;
	
	Outputs.Ivert = u_vertical;
	Outputs.Ihor = u_horizontal;
	
	return Outputs;
}


LQRouputs  LQR::MIMO_CONTROL_NEGATIVE(float R_ref, float Z_ref, float R_real, float Z_real, float I_vertical, float I_horizontal){
	float u_Nbar_0 = 0;
	float u_Nbar_1 = 0;
	float u_vertical=0;
	float u_horizontal=0;
	int i = 0;
	int j = 0;
	float temp = 0.0;
	float *outputs;
	outputs =(float[2]) {0, 0};
	LQRouputs Outputs={0,0};
	
	
	
	//Nbar(2x2)
	u_Nbar_0 = (R_ref* this->N_BAR_neg[0]) + (Z_ref* this->N_BAR_neg[1]);
	u_Nbar_1 = (R_ref * this->N_BAR_neg[2]) + (Z_ref * this->N_BAR_neg[3]);
	
	//u=u-k_lqr*x
	for (i = 0; i < N_state; i++) {
		temp += this->X_LQR[i] * this->K_LQR_neg[i];	
	}
	u_vertical = u_Nbar_0 - temp;
	temp = 0.0;	
	
	for (i = 0; i < N_state; i++) {
		temp += this->X_LQR[i] * this->K_LQR_neg[i+N_state];
		
	}
	u_horizontal = u_Nbar_1 - temp;
		temp = 0.0;
		
	Outputs.Ivert = u_vertical;
	Outputs.Ihor = u_horizontal;
	
	return Outputs;
}




///////////////////////////////////////////// KALMAN FILTERS////////////////////////////////////////////////////////





Kalman LQR:: KALMAN_FILTER_POS(float R_real, float Z_real, float I_vertical, float I_horizontal, int sign){
	//the same as before
	//if we use this in mimo class we can comment from 102 to 115
	//i putted because we can copy this in IPID class
	float temp=0.0;
	int j=0;
	int i=0;
	int m=0;
	int n=0;
	// buffers time
	
	float buff=0.0;
	float buffer=0.0;
	
	
	float* y_est;
	y_est =(float[2]){0, 0};
	float* X_est;
	X_est =(float[10]){0, 0,0,0,0,0,0,0,0,0};
	
	
	Kalman Outputs={0.085,0.085,X_est};
	
	for(i=0; i< N_state; i++){
		buff = this->x_pos[i];
		this->X_LQR[i] = buff;
	}
	buff=0.0;	
			
	if(sign == 1){	
		
		for(j = 0; j < N_state; j++){
			buff = 0.0;
			for (i = 0; i < N_state; i++) {
				m=i + j*(N_state);
				buff = buff + this->A_est_pos[m] * this->x_pos[i];
			}
			this->x_dot_pos[j] = buff;
		}
		
		for(i = 0; i < N_state; i++){
			j= i + (N_state);
			m=i + 2*(N_state);
			n=i + 3*(N_state);
			temp =  this->B_est_pos[i] * I_vertical + this->B_est_pos[j] * I_horizontal + this->B_est_pos[m] * R_real + this->B_est_pos[n] * Z_real;
			this->x_dot_pos[i] += temp;
			
		}
		temp = 0.0;
		
		//x^(k+1) = A_est * x(k)+ B_est * u(k)
				
		//[y_est x_est] = C_est x_est + D_est [u_real y_real]
		for(j = 0; j < N_output; j++){
			buff = 0.0;
			for (i = 0; i < N_state; i++) {
				m=i + j*(N_state);
				 buff += this->C_est_pos[m] * this->x_pos[i];
			}
			y_est[j] = buff;
		}
		
	

			buff =  this->D_est_pos[24] * R_real + this->D_est_pos[36] * Z_real;
			y_est[0] += buff;
			buff = 0.0;
			buff =  this->D_est_pos[25] * R_real + this->D_est_pos[37] * Z_real;
			y_est[1] += buff;
			buff = 0.0;
			
			

		

		
			//x(k)=x(k+1) for the next step

		
		Outputs.Kalman_R= y_est[0];
		Outputs.Kalman_Z= y_est[1];
		Outputs.X_est= this-> x_pos;
		
		buffer = 0.0;
		for (i = 0; i < N_state; i++) {
			buffer =this->x_dot_pos[i];
			this->x_pos[i]=buffer;
		}
		
		}else{
			Outputs.Kalman_R= 0.085;
			Outputs.Kalman_Z= 0.085;
				for (i = 0; i < N_state; i++) {
						X_est[i]=0.0;}
										
			Outputs.X_est=X_est;
			}
	

	return Outputs;
	
}

Kalman LQR:: KALMAN_FILTER_NEG(float R_real, float Z_real, float I_vertical, float I_horizontal, int sign){
	//the same as before
	//if we use this in mimo class we can comment from 102 to 115
	//i putted because we can copy this in IPID class
	float temp=0.0;
	int j=0;
	int i=0;
	int m=0;
	int n=0;
	// buffers time
	
	float buff=0.0;
	float buffer=0.0;
	

	float* y_est;
	y_est =(float[2]){0, 0};
	float* X_est;
	X_est =(float[10]){0, 0,0,0,0,0,0,0,0,0};
	Kalman Outputs={0.085,0.085,X_est};
	
	for(i=0; i< N_state; i++){
		buff = this->x_neg[i];
		this->X_LQR[i] = buff;;
	}
	buff=0.0;	
	if(sign == 1){	
		
		for(j = 0; j < N_state; j++){
			buff = 0.0;
			for (i = 0; i < N_state; i++) {
				m=i + j*(N_state);
				buff = buff + this->A_est_neg[m] * this->x_neg[i];
			}
			this->x_dot_neg[j] = buff;
		}
		
		for(i = 0; i < N_state; i++){
			j= i + (N_state);
			m=i + 2*(N_state);
			n=i + 3*(N_state);
			temp =  this->B_est_neg[i] * I_vertical + this->B_est_neg[j] * I_horizontal + this->B_est_neg[m] * R_real + this->B_est_neg[n] * Z_real;
			this->x_dot_neg[i] += temp;
			
		}
		temp = 0.0;

		
		
		//[y_est x_est] = C_est x_est + D_est [u_real y_real]
		for(j = 0; j < N_output; j++){
			buff = 0.0;
			for (i = 0; i < N_state; i++) {
				m=i + j*(N_state);
				 buff += this->C_est_neg[m] * this->x_neg[i];
			}
			y_est[j] = buff;
		}
		


			buff =  this->D_est_neg[24] * R_real + this->D_est_neg[36] * Z_real;
			y_est[0] += buff;
			buff = 0.0;
			buff =  this->D_est_neg[25] * R_real + this->D_est_neg[37] * Z_real;
			y_est[1] += buff;
			buff = 0.0;
		
			

		
			//x(k)=x(k+1) for the next step

		
		Outputs.Kalman_R= y_est[0];
		Outputs.Kalman_Z= y_est[1];
		Outputs.X_est=this->x_neg;
		
		buffer = 0.0;
		for (i = 0; i < N_state; i++) {
			buffer =this->x_dot_neg[i];
			this->x_neg[i]=buffer;
		}
		
		}else{
			Outputs.Kalman_R= 0.085;
			Outputs.Kalman_Z= 0.085;
				for (i = 0; i < N_state; i++) {
						X_est[i]=0.0;}
										
			Outputs.X_est=X_est;
			}
	

	return Outputs;
	
}
int LQR:: erase() {
	int i = 0;
	float* state0_pos;
	float* state0_neg;
	state0_pos = (float[N_state]){0.0983539734804260, 0.480564466137287, -0.204246862173158, 0.0605647026605041, -0.369796209977501, 0.111380460346364, 0.0194246756583234, 0.144179620264490, -0.0534417070457820, 0.215640033094750}; 
	state0_neg=(float[N_state])  {-0.01322152646,	0.21257243483,	0.24681826366,	-0.33280829935,	-0.00461930354,	0.02045689304,	-0.05335478233,	0.02913866606,	-0.38100515631,	-0.01904457052};

	for (i = 0; i < N_state; i++) {
			this->x_dot_pos[i]=0.0;
		}
	for (i = 0; i < N_state; i++) {
			this->x_dot_neg[i]=0.0;
		}
	for (i = 0; i < N_state; i++) {
			this->x_pos[i]=state0_pos[i];
		}
	for (i = 0; i < N_state; i++) {
			this->x_neg[i]=state0_neg[i];
		}

	
	return 1;
	}


	/* POSITIVE
	/////normal
	this-> N_BAR_pos = (float[N_input +  N_output]){-16738.8719868375, 3479.82442345434,
							488.651395096507, -28.3958381254954};	
	this-> K_LQR_pos =(float[N_input * N_state]) {-39.8874724584811, -70.6769666120137, 354.869808121735, 370.159896447712, -106.569303855515, -10.6727031034049, -29.8250480200422, 75.3583282160950, -135.655340474040, -27.8586258177635,
							4.85034537803885, 16.3699444462248, -103.189045436383, -88.9493312103841, 36.1506690550597, 19.0337453517795, 10.4943236824918, -28.3848265454111, 45.6326833691854, 8.77044127460252};
	/////slow
	this-> N_BAR_pos = (float[N_input +  N_output]){-11086.5128004769, 2304.91025662465,
							-624.913612903589, 203.085650822326};
	this-> K_LQR_pos =(float[N_input * N_state]) {-8.01681293888861, -26.8325522087463, 134.585605910785, 71.3907687002046, -31.1613639245902, 1.06653823136754, -8.67641023817368, 30.6278817417476, -52.6867168563030, -17.6236782619040,
							-0.359505258997209, 5.27976739349132, -34.7284975804598, -24.9860321020505, 10.5336478520904, 3.20301260401835, 2.98116013872604, -9.62426558998255, 15.6891220336232, 4.25997674316981};
	
	
	//more slow
	this-> N_BAR_pos = (float[N_input +  N_output]){-10292.2693526553, 2133.74129809333,
							-944.140351815484, 269.810568562941};
	this-> K_LQR_pos =(float[N_input * N_state]) {-0.677239930551175, -5.56445051715661, 29.1530400398665, 10.5689835482429, -6.43042836144154, 0.784006911127944, -1.67848331436731, 6.89611601694075, -11.6198347798690, -4.41024916164279,
							-0.253637909222695, 0.998896201615173, -6.91291373508615, -4.34730845911924, 2.02654430640833, 0.350198601401546, 0.540286005706202, -1.95918796444674, 3.18376611395890, 0.992300688479676};
	
	*/
	/* NEGATIVE
	//////normal
	this-> K_LQR_neg=(float[N_input * N_state])  {-1.10243700688381, -26.6888168111469, 248.208386299799, 2272.69314089294, 341.435985384170, 116.974185358079, -1571.00753489878, -331.351679250269, -1271.06969797964, -4441.09340489016,
							-0.233414809301534, -21.1374545809135, 237.120488501101, 3170.68925311282, -143.026532612836, 258.466914847382, -1451.21045848359, -298.057584698670, -925.765520002125, -4247.87411829111};
	this-> N_BAR_neg=(float[N_input +  N_output]) {6692.27395164254, -960.635617013133,
							-2256.41280370701, -489.068332481912};
		
	/////slow
	this-> N_BAR_pos = (float[N_input +  N_output]){6589.72680834879, -954.006515986846,
							-2507.09039980905, -438.508741661756};
	this-> K_LQR_pos =(float[N_input * N_state]) {-0.140009763339089, -3.18557215603840, 30.5815322306256, 261.182404835037, 41.0701964065595, 15.1457297490992, -184.071391002032, -37.9502637307121, -150.255931786410, -524.709987410739,
							-0.0430382829459303, -2.40364558484570, 28.2516724393487, 349.930303853398, -19.3580296640594, 27.8929619552656, -166.244389576828, -34.2340029306290, -102.365591295273, -474.430220412449};
	
	
	//more slow
	this-> N_BAR_pos = (float[N_input +  N_output]){6577.20274262693, -953.521247320254,
							-2537.02933847542, -432.837113235285};
	this-> K_LQR_pos =(float[N_input * N_state]) {-0.0143959540956107, -0.325150394017629, 3.13416013810849, 26.5396916000373, 4.19324806144036, 1.55806909562497, -18.7468162690424, -3.85545880019961, -15.3160343140834, -53.4859040919299,
							-0.00458150757613837, -0.243881430718078, 2.88347865234915, 35.3882054725928, -2.01002787695297, 2.81135503841810, -16.8859632308927, -3.47894536276546, -10.3473795912101, -48.0323686610169};
	
	*/
